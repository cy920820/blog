<!DOCTYPE html>
<html lang="{{ page.lang | default: "en" }}">
  {%- include head.html -%}
  <body a="{{ site.theme_config.appearance | default: "auto" }}">
    <main class="page-content" aria-label="Content">
      <div class="w">
        {{ content }}
      </div>
    </main>
    {%-if site.goat_counter and jekyll.environment == "production"-%}
      {%-include goat_counter.html-%}
    {%-endif-%}

    <script type="text/javascript" src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/pixi.js@5.3.6/dist/pixi.min.js"></script>
    <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/pixi-live2d-display@0.3.1/dist/cubism4.min.js"></script>
    <script type="text/javascript" src="https://fastly.jsdelivr.net/gh/journey-ad/blog-img@94eb7e2/live2d/lib/pio_sdk4.js"></script>
    <script type="text/javascript" src="https://fastly.jsdelivr.net/gh/journey-ad/blog-img@94eb7e2/live2d/lib/pio.js"></script>

    {% if page.custom_js %}
      {% for js_file in page.custom_js %}
        <script type="text/javascript" src="{{ site.baseurl }}/assets/js/{{ js_file }}.js"></script>
      {% endfor %}
    {% endif %}

    <script>
      window.onload = () => {
        const conf = {
          mode: "fixed",
          hidden: true,
          content: {
            referer: "Hi!", // 存在访问来源时的欢迎文本
            welcome: ["Hi!"], // 未开启时间问好时的欢迎文本
            skin: ["诶，想看看其他团员吗？", "替换后入场文本"], // 0更换模型提示文案  1更换完毕入场文案
            custom: [
              // 鼠标移上去提示元素
              {
                selector:
                  ".most-viewed-panel .most-viewed-item, .live-up-list .live-detail, .card .user-name, .user .name, .post-content .content-full a, .tag-list .content, .title, h2 a[title]",
                type: "link"
              }
            ]
          },
          model: [
            // 待加载的模型列表
            "https://fastly.jsdelivr.net/gh/journey-ad/blog-img/live2d/Diana/Diana.model3.json",
            "https://fastly.jsdelivr.net/gh/journey-ad/blog-img/live2d/Ava/Ava.model3.json"
          ],
          tips: true, // 时间问好
          onModelLoad: onModelLoad // 模型加载完成回调
        }

        let pio_reference = null;

        // 模型加载完成回调
        function onModelLoad(model) {
          const canvas = document.getElementById("pio")
          const modelName = model.internalModel.settings.name
          const coreModel = model.internalModel.coreModel
          const motionManager = model.internalModel.motionManager
          let touchList = [
            {
              text: "点击展示文本1",
              motion: "Idle"
            },
            {
              text: "点击展示文本2",
              motion: "Idle"
            }
          ]
          // 播放动作
          function playAction(action) {
            action.text && pio_reference.modules.render(action.text) // 展示文案
            action.motion && pio_reference.model.motion(action.motion) // 播放动作
            if (action.from && action.to) {
              // 指定部件渐入渐出
              Object.keys(action.from).forEach((id) => {
                const hidePartIndex = coreModel._partIds.indexOf(id)
                TweenLite.to(coreModel._partOpacities, 0.6, {
                  [hidePartIndex]: action.from[id]
                })
                // coreModel._partOpacities[hidePartIndex] = action.from[id]
              })
              motionManager.once("motionFinish", (data) => {
                Object.keys(action.to).forEach((id) => {
                  const hidePartIndex = coreModel._partIds.indexOf(id)
                  TweenLite.to(coreModel._partOpacities, 0.6, {
                    [hidePartIndex]: action.to[id]
                  })
                  // coreModel._partOpacities[hidePartIndex] = action.to[id]
                })
              })
            }
          }
          canvas.onclick = function () {
            // 除闲置动作外不打断
            if (motionManager.state.currentGroup !== "Idle") return
            // 随机选择并播放动作
            const action = pio_reference.modules.rand(touchList)
            playAction(action)
          }
          if (modelName === "Diana") {
            // 嘉然小姐
            // 入场动作及文案
            conf.content.skin[1] = [
              "我是吃货担当 嘉然 Diana~",
              "嘉心糖们 想然然了没有呀~",
              "有人在吗？"
            ]
            playAction({ motion: "Tap抱阿草-左手" })
            // 点击动作及文案，不区分区域
            touchList = [
              {
                text: "嘉心糖屁用没有",
                motion: "Tap生气 -领结"
              },
              {
                text: "有人急了，但我不说是谁~",
                motion: "Tap= =  左蝴蝶结"
              },
              {
                text: "呜呜...呜呜呜....",
                motion: "Tap哭 -眼角"
              },
              {
                text: "想然然了没有呀~",
                motion: "Tap害羞-中间刘海"
              },
              {
                text: "阿草好软呀~",
                motion: "Tap抱阿草-左手"
              },
              {
                text: "不要再戳啦！好痒！",
                motion: "Tap摇头- 身体"
              },
              {
                text: "嗷呜~~~",
                motion: "Tap耳朵-发卡"
              },
              {
                text: "zzZ。。。",
                motion: "Leave"
              },
              {
                text: "哇！好吃的！",
                motion: "Tap右头发"
              }
            ]
          } else if (modelName === "Ava") {
            initConfig.content.skin[1] = [
              "我是<s>拉胯</s>Gamer担当 羽高 AvA~",
              "怎么推流辣！",
              "AAAAAAAAAAvvvvAAA 羽高！"
            ]
            playAction({
              motion: "Tap左眼",
              from: {
                Part15: 1
              },
              to: {
                Part15: 0
              }
            })
            touchList = [
              {
                text: "水母 水母~ 只是普通的生物",
                motion: "Tap右手"
              },
              {
                text: "可爱的鸽子鸽子~我喜欢你~",
                motion: "Tap胸口项链",
                from: {
                  Part12: 1
                },
                to: {
                  Part12: 0
                }
              },
              {
                text: "好...好兄弟之间喜欢很正常啦",
                motion: "Tap中间刘海",
                from: {
                  Part12: 1
                },
                to: {
                  Part12: 0
                }
              },
              {
                text: "啊啊啊！怎么推流辣",
                motion: "Tap右眼",
                from: {
                  Part16: 1
                },
                to: {
                  Part16: 0
                }
              },
              {
                text: "你怎么老摸我，我的身体是不是可有魅力",
                motion: "Tap嘴"
              },
              {
                text: "AAAAAAAAAAvvvvAAA 羽高！",
                motion: "Tap左眼",
                from: {
                  Part15: 1
                },
                to: {
                  Part15: 0
                }
              }
            ]
            // 钻头比较大，宽度*1.2倍，模型位移也要重新计算
            canvas.width = model.width * 1.2
            model.x = canvas.width - model.width
            // 模型问题，手动隐藏指定部件
            const hideParts = [
              "Part5", // 晕
              "neko", // 喵喵拳
              "game", // 左手游戏手柄
              "Part15", // 墨镜
              "Part21", // 右手小臂
              "Part22", // 左手垂下
              "Part", // 双手抱拳
              "Part16", // 惊讶特效
              "Part12" // 小心心
            ]
            const hidePartsIndex = hideParts.map((id) => coreModel._partIds.indexOf(id))
            hidePartsIndex.forEach((idx) => {
              coreModel._partOpacities[idx] = 0
            })
          }
        }
        function loadPio () {
          pio_reference = new Paul_Pio(conf)
          const closeBtn = document.querySelector(".pio-container .pio-action .pio-close")
          closeBtn.insertAdjacentHTML("beforebegin", '<span class="pio-top"></span>')
          const topBtn = document.querySelector(".pio-container .pio-action .pio-top")
          // 返回顶部
          topBtn.onclick = function () {
            window.scrollTo({ top: 0, behavior: "smooth" })
          }
          topBtn.onmouseover = function () {
            pio_reference.modules.render("想回到页面顶部吗？")
          }
        }
        loadPio()
      }
    </script>
  </body>
</html>
